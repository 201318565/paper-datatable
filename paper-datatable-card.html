<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="paper-datatable.html">
<link rel="import" href="paper-datatable-column.html">

<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-progress/paper-progress.html">

<script src="weakCache.js"></script>
<dom-module id="paper-datatable-card">
	<template>
		<style>
			:host {
				display: block;
				background: white;
			}
			#selectionToolbar{
				display: none;
				background: var(--light-primary-color);
				padding:0px 12px 0px 24px;
			}
			#selectionToolbar[data-visible]{
				display: flex;
			}
			#toolbar-main{
				padding-right: 12px;
			}
			paper-dropdown-menu{
				vertical-align: middle;
			}
		</style>
		<paper-material elevation="1">
			<div class="horizontal center layout" style="height:64px;padding:0px 6px 0px 24px;position:relative;">
				<div class="flex" style="font-size:20px;font-family:Roboto">
					<span>{{header}}</span>
				</div>
				<div id="toolbar-main" class="toolbar">
					<content select="*[toolbar-main]"></content>
				</div>
				<div id="selectionToolbar" class="horizontal center layout fit" data-visible$="[[_selectedToolbarVisible]]">
					<div class="flex" style="font-size:16px;font-family:Roboto">
						<span>[[_numberselectedIds]]</span> item selected
					</div>
					<div class="toolbar">
						<content select="*[toolbar-select]"></content>
					</div>
				</div>
			</div>
			<div style="">
				<content select="paper-datatable"></content>
			</div>
			<div class="horizontal center layout" style="height:56px;padding:0px 6px;border-top:1px solid rgb(240,240,240);">
				<div class="flex"></div>
				<div>
					Rows per page:
					<paper-dropdown-menu no-label-float style="width: 68px;">
						<paper-menu class="dropdown-content" selected="{{pageSize}}" attr-for-selected="value">
							<paper-item value="5">5</paper-item>
							<paper-item value="10">10</paper-item>
							<paper-item value="25">25</paper-item>
							<paper-item value="100">100</paper-item>
						</paper-menu>
					</paper-dropdown-menu>
					<span>[[_getRangeStart(page, pageSize)]]</span>-<span>[[_getRangeEnd(page, pageSize, dataSource.length)]]</span> of <span>[[dataSource.length]]</span>
					<paper-icon-button icon="chevron-left" on-tap="prevPage" disabled="[[_prevPageDisabled(page)]]"></paper-icon-button>
					<paper-icon-button icon="chevron-right" on-tap="nextPage" disabled="[[_nextPageDisabled(page, pageSize, dataSource.length)]]"></paper-icon-button>
				</div>
			</div>
		</paper-material>
	</template>

	<script>
		(function () {
			'use strict';

/*
 Still to be written, but in the meantime, check the `paper-datatable-card` demo.

 @element paper-datatable-card
 @demo demo/paper-datatable-card.html
*/

			Polymer({

				is: 'paper-datatable-card',
				properties: {
					header: String,
					dataSource: Object,
					pageSize: {
						type: Number,
						value: 10
					},
					page: {
						type: Number,
						value: 1
					},
					_disableSave: {
						type: Boolean,
						value: false
					},
					_datatable: {
						type: Object
					}
				},
				ready: function(){
					this._datatable = Polymer.dom(this).querySelector("paper-datatable");
					this._datatable.data = [];
					this._datatable.addEventListener("data-changed", this._triggerSave.bind(this));
					this._datatable.addEventListener("selected-id-changed", this._setSelectedToolbarVisible.bind(this));
					this._datatable.addEventListener("selected-ids-changed", this._setSelectedToolbarVisible.bind(this));
					this._datatable.addEventListener("sort", this._handleSort.bind(this));
				},
				observers: [
					'_getVisibleData(dataSource, pageSize, page, _datatable)'
				],
				_triggerSave: function(ev){
					if(!this._disableSave && ev.detail.path){
						var path = ev.detail.path.split(".");
						if(path.length == 2){
							return;
						}
						var item = path.shift();
						var rowKey = path.shift();

						var property = path.shift();
						var value = ev.detail.value;
						var data = this._datatable.get("data."+rowKey);
						var id = data[this._datatable.idProperty];

						//todo: complex objects 2+
						console.log(path);
						if(path.length > 0){
							value = data[property];
							this.dataSource.set(data, property, data);
						}else{
							this.dataSource.set(data, property, value);
						}

					}
				},
				_handleSort: function(ev){
					console.info(ev.detail);
					ev.preventDefault();
					this._getVisibleData();
				},
				_getVisibleData: function(){

					this.debounce("visibleData", function(){
						this._disableSave = true;

						var processItems = function(items){

							this._datatable.splice("data", 0, this._datatable.data.length);

							var args = ["data"].concat(items);
							this._datatable.push.apply(this._datatable,args);

							this._disableSave = false;
							/*items.forEach(function(item){

							 }.bind(this));*/

						}.bind(this);

						var queryArgs = [{property: this._datatable.sortProperty, direction: this._datatable.sortDirection}, this.page, this.pageSize];

						this._datatable.splice("data", 0, this._datatable.data.length);

						if('queryForIds' in this.dataSource){
							var ids = this.dataSource.queryForIds.apply(this.dataSource, queryArgs);

							//todo: do not retrieve items which we put in the cache
							this.dataSource.getByIds(ids).then(processItems);
						}else{
							this.dataSource.get.apply(this.dataSource, queryArgs).then(processItems);
						}
					}, 0);

				},
				_getRangeStart: function(){
					return (this.page-1)*this.pageSize;
				},
				_getRangeEnd: function(){
					return Math.min((this.page)*this.pageSize, this.dataSource.length);
				},
				nextPage: function(){
					this.set("page", this.page+1);
				},
				prevPage: function(){
					this.set("page", this.page-1);
				},
				_prevPageDisabled: function(){
					return this.page == 1;
				},
				_nextPageDisabled: function(){
					return this.page * this.pageSize >= this.dataSource.length;
				},
				_setSelectedToolbarVisible: function(){
					if(this._datatable.multiSelection){
						this._selectedToolbarVisible = this._datatable.selectedIds.length > 0;
						this._numberselectedIds = this._datatable.selectedIds.length;
					}else{
						this._selectedToolbarVisible = this._datatable.selectedId ? true : false;
						this._numberselectedIds = this._datatable.selectedId ? 1 : 0;
					}
				}

			});

		})();
	</script>

</dom-module>
