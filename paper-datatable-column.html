<dom-module id="paper-datatable-column">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<template id="arrayTemplate">
			<template is="dom-repeat" items="{{value}}" as="arrayItem">
				<div class="array-tag">{{_getArrayItemLabel(arrayItem)}}</div>
			</template>
			<!--
			<template is="dom-if" if="{{column.arrayDisplayProp}}">
				<template is="dom-repeat" items="{{value}}" as="arrayItem">
					<div class="array-tag">{{_getProp(arrayItem, column.arrayDisplayProp)}}</div>
				</template>
			</template>
			<template is="dom-if" if="{{!column.arrayDisplayProp}}">
				<template is="dom-repeat" items="{{value}}" as="arrayItem">
					<div class="array-tag">{{arrayItem}}</div>
				</template>
			</template>
			-->
		</template>
	</template>

	<script>
		(function () {
			'use strict';

			Polymer({
				is: 'paper-datatable-column',
				properties: {
					header: String,
					property: String,
					type: {
						type: String,
						value: 'String'
					},
					tooltip: String,
					sortable: Boolean,
					editable: Boolean,
					/**
					 * If `type` is an `Array` and the array consists of `Object`s it's a common need
					 * to display a single property of every object (in non-editable mode).
					 *
					 * @attribute arrayDisplayProp
					 * @type String
					 * @default
					 */
					arrayDisplayProp: String,
					_styleString: {
						type: String,
						value: function(){
							return this.getAttribute('style');
						}
					},
					default: Object,
					align: {
						type: String,
						value: 'left'
					}
				},
				ready: function() {
					var template = Polymer.dom(this).querySelector('template');
					if(!template && this.type.toLowerCase() == "array"){
						var template = this.$.arrayTemplate;
					}
					if(template) {

						this._instanceProps = {};
						this._instanceProps.item = true;
						this._instanceProps.value = true;
						this._instanceProps.column = true;

						this.templatize(template);

						this.template = true;

					}
				},
				attached: function() {
					Polymer.dom(this).parentNode.push('columns', this);
					this.parentNodeRef = Polymer.dom(this).parentNode;
				},
				detached: function() {
					this.parentNodeRef.splice('columns', this.parentNodeRef.columns.indexOf(this), 1);
				},
				update: function(){
					var that = this;
					Object.keys(this.properties).forEach(function(property){
						if(property !== 'config'){
							console.log(that.get('config'));
							that.set('config.'+property, that.get(property));
						}
					});
					console.log(this.config);
				},
				createCellInstance: function(model, notificationId, notificationProp){
					if(typeof model[this.property] == "undefined" && typeof this.default !== "undefined"){
						var instance = this.stamp({item: model, column:this, value: this.default, _dataId: notificationId});
					}else{
						var instance = this.stamp({item: model, column:this, value: model[this.property], _dataId: notificationId});
					}

					instance._getProp = function(obj, prop){
						return obj[prop];
					};

					//console.log(instance, {id: notificationId, prop: notificationProp});
					//this.map.set(instance, {id: notificationId, prop: notificationProp});
					return instance;
				},
				formatValue: function(data){
					if(typeof data == 'undefined'){
						return '';
					}
					var value = this._cast(data);
					if(this.type.toLowerCase() == 'string'){
						return value;
					}else if(this.type.toLowerCase() == 'number'){
						return value;
					}else if(this.type.toLowerCase() == 'boolean'){
						return value ? 'Yes' : 'No';
					}else if(this.type.toLowerCase() == 'date'){
						return value.getUTCFullYear() +'/'+ (value.getUTCMonth()+1) +'/'+ value.getUTCDate() + ' ' + value.getUTCHours() + ':' + value.getUTCMinutes() + ':' + value.getUTCSeconds();
					}else{
						return '?';
					}
				},
				_cast: function(value){
					if(this.type.toLowerCase() == 'string'){
						return value.toString();
					}else if(this.type.toLowerCase() == 'number'){
						return parseFloat(value);
					}else if(this.type.toLowerCase() == 'boolean'){
						return value ? true : false;
					}else if(this.type.toLowerCase() == 'date'){
						return new Date(value);
					}else{
						return value;
					}
				},
				behaviors: [
					Polymer.Templatizer
				],
				_forwardParentProp: function(prop, value){
					console.warn('_forwardParentProp',arguments);
				},
				_forwardParentPath: function(prop, value){
					console.warn('_forwardParentPath',arguments);
				},
				_forwardInstanceProp: function(templateInstance, prop, value){
					var path = prop.split('.');
					var item = path.shift();
					var dataRowI = this.parentNodeRef._getDataRowIFromID(templateInstance.get('_dataId'));
					if(item == 'value'){
						var parentPath = ['data', dataRowI, this.property].join('.');
						value = this._cast(value);
						//console.log('_forwardInstanceProp',arguments);
						//console.log('set', parentPath, 'to', value);
						this.parentNodeRef.set(parentPath, value);

					}else if(item == 'item'){
						console.warn('_forwardInstanceProp',arguments);
					}
				},
				_forwardInstancePath: function(templateInstance, prop, value){
					//var path = this.map.get(templateInstance);
					//todo: Re-Implement complex objects
					//var notification = this.map.get(templateInstance);
					//var path = ['data' , this.parentNodeRef._getDataRowIFromID(notification.id), notification.prop];

					//if(prop.replace('item','').length > 0){
					//	path.push(prop.replace('item',''));
					//}
					//console.log(path);
					//this.parentNodeRef.set(path.join('.'), value);


					var path = prop.split('.');
					var item = path.shift();
					var dataRowI = this.parentNodeRef._getDataRowIFromID(templateInstance.get('_dataId'));
					if(item == 'value'){
						var parentPath = ['data', dataRowI, this.property].concat(path).join('.');
						if(path.length == 0){
							value = this._cast(value);
						}
						//console.log(parentPath, path.join('.'), value)
						//console.log('_forwardInstancePath',arguments);
					}else if(item == 'item'){
						var parentPath = ['data', dataRowI].concat(path).join('.');
						//console.log(parentPath, value);
						//console.log('_forwardInstancePath',arguments);
					}
					//console.log('set', parentPath, 'to', value);
					this.parentNodeRef.set(parentPath, value);
				},
				_getRootDataHost: function(){
					return this;
				},
				_getArrayItemLabel: function(value){
					return this.arrayDisplayProp ? value[this.arrayDisplayProp] : value;
				},
				_getProp: function(obj, prop){
					return obj[prop];
				}


			});
		})();
	</script>

</dom-module>
