<!doctype html>
<html>
	<head>
		<title></title>
		<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
		<link rel="import" href="../../polymer/polymer.html">
		<link rel="import" href="../paper-datatable-card.html">
		<link rel="import" href="../paper-datatable.html">
	</head>
	<body>


		<template is="dom-bind" id="app">

			<style is="custom-style">
				body{
					background: #f5f5f5;
				}
			</style>

			<paper-datatable-card id="datatableCard" header="Document library" page-size="10" data-source="{{data}}">
				<div toolbar-main>
					<paper-icon-button icon="add" on-tap="addNew"></paper-icon-button>
				</div>
				<div toolbar-select>
					<paper-icon-button icon="delete"></paper-icon-button>
				</div>
				<paper-datatable selectable>
					<paper-datatable-column header="Author" property="author" tooltip="The total amount of..." style="min-width: 400px" default='{"first": "", "last": ""}' editable>
						<template>
							<paper-input value="{{value.first}}" no-label-float style="display:inline-block;width:182px;"></paper-input>
							<paper-input value="{{value.last}}" no-label-float style="display:inline-block;width:182px;"></paper-input>
						</template>
					</paper-datatable-column>
					<paper-datatable-column header="Document title" property="title" type="String" tooltip="Some title" sortable style="width: 99%"></paper-datatable-column>
					<paper-datatable-column header="Rating" property="rating" type="Number" tooltip="The total amount of..." sortable style="min-width: 200px" editable>
						<template>
							<paper-input value="{{value}}" no-label-float></paper-input>
						</template>
					</paper-datatable-column>
					<paper-datatable-column property="reserved" header="Reserved" type="boolean" default="false" style="min-width: 100px" cell-style="padding-left:40px;" align="center" editable>
						<template>
							<paper-checkbox checked="{{value}}"></paper-checkbox>
						</template>
					</paper-datatable-column>
				</paper-datatable>
			</paper-datatable-card>

		</template>

		<script>
			var app = document.querySelector('#app');

			var myData = [];
			for (var i=0; i<142; i++) {
				var id = i*10000+Math.round(Math.random() * 500);
				var rating = Math.round(Math.random() * 2000)+1000;
				myData.push({
					id: id,
					title: "title"+id,
					rating: rating,
					author: {
						first: "David",
						last: "Mulder "+ id
					},
					reserved: (Math.random() > 0.9 ? true : undefined)
				});
			}
			window.myData = myData;

			app.data = {
				getByIds: function(ids){
					return new Promise(function(resolve, reject){
						var data = [];
						ids.forEach(function(id){
							data.push(myData.find(function(item){
								return item.id == id;
							}));
						});
						resolve(data);
					});
				},
				set: function(item, property, value){
					return new Promise(function(resolve, reject){
						console.info("a save was triggered", [item, property, value]);
						if(item.id === '__new__'){
							//validate item, if invalid (and thus not savable yet) reject, otherwise return it's new id
							if(item.author.first.length > 0 && item.author.last.length > 0){
								console.log('trigger save');
								var id = Math.round(Math.random() * 10000);

								item.id = id;
								myData.push(item);
								app.set('data.length', myData.length);
								resolve(id);
							}else{
								console.log('no luck yet');
								reject();
							}
						}else{
							var myItem = myData.find(function(thisItem){
								return thisItem.id == item.id;
							});
							myItem[property] = value;
							resolve(true);
						}
					});

				},
				queryForIds: function(sort, page, limit){
					// query = {search: "test"}
					// sort = {property: "something", direction: "asc"}
					// page = 1
					// limit = 10
					myData.sort(function(a,b){
						if(sort.direction == "asc"){
							var c = a;
							a = b;
							b = c;
						}
						if(a[sort.property] > b[sort.property]) return 1;
						if(a[sort.property] < b[sort.property]) return -1;
						return 0;
					});
					return myData.slice((page-1)*limit, page*limit).map(function(item){
						return item.id;
					});
				},
				length:myData.length
			};

			app.addNew = function(){
				this.$.datatableCard.addNew();
			};

		</script>

	</body>
</html>
